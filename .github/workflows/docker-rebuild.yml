name: Docker Rebuild

on:
  schedule:
    # Weekly on Monday at 06:00 UTC â€” picks up base image security patches
    - cron: "0 6 * * 1"
  workflow_dispatch:

concurrency:
  group: docker-rebuild
  cancel-in-progress: true

jobs:
  prepare:
    name: Compute version & timestamp
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      unix: ${{ steps.ts.outputs.unix }}
      is-stable: ${{ steps.version.outputs.is-stable }}
    steps:
      - uses: actions/checkout@v6
      - id: version
        run: |
          V="$(jq -r .version package.json)"
          echo "version=$V" >> "$GITHUB_OUTPUT"
          if [[ "$V" != *-* ]]; then
            echo "is-stable=true" >> "$GITHUB_OUTPUT"
          else
            echo "is-stable=false" >> "$GITHUB_OUTPUT"
          fi
      - id: ts
        run: echo "unix=$(date +%s)" >> "$GITHUB_OUTPUT"

  rebuild:
    needs: prepare
    uses: codefuturist/shared-workflows/.github/workflows/docker-build-push.yml@v1
    permissions:
      contents: read
      packages: write
    with:
      images: |
        ghcr.io/codefuturist/email-mcp
        diarmid/email-mcp
      tags: |
        type=semver,pattern={{version}},value=v${{ needs.prepare.outputs.version }}
        type=semver,pattern={{version}},suffix=-bookworm,value=v${{ needs.prepare.outputs.version }}
        type=semver,pattern={{major}}.{{minor}},value=v${{ needs.prepare.outputs.version }}
        type=semver,pattern={{major}}.{{minor}},suffix=-bookworm,value=v${{ needs.prepare.outputs.version }}
        type=semver,pattern={{major}},value=v${{ needs.prepare.outputs.version }}
        type=semver,pattern={{major}},suffix=-bookworm,value=v${{ needs.prepare.outputs.version }}
        type=raw,value=bookworm
        type=sha,prefix=sha-
        type=raw,value=latest,enable=${{ needs.prepare.outputs.is-stable }}
        type=raw,value=ts-${{ needs.prepare.outputs.unix }}
        type=raw,value=${{ needs.prepare.outputs.unix }}
      alpine-tags: |
        type=semver,pattern={{version}},suffix=-alpine,value=v${{ needs.prepare.outputs.version }}
        type=semver,pattern={{major}}.{{minor}},suffix=-alpine,value=v${{ needs.prepare.outputs.version }}
        type=semver,pattern={{major}},suffix=-alpine,value=v${{ needs.prepare.outputs.version }}
        type=raw,value=alpine,enable=${{ needs.prepare.outputs.is-stable }}
    secrets:
      GHCR_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
